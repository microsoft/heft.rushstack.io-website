"use strict";(self.webpackChunkheft_rushstack_io=self.webpackChunkheft_rushstack_io||[]).push([[8810],{158:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(6393);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),h=p(n),d=i,m=h["".concat(l,".").concat(d)]||h[d]||u[d]||r;return n?a.createElement(m,s(s({ref:t},c),{},{components:n})):a.createElement(m,s({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,s=new Array(r);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[h]="string"==typeof e?e:i,s[1]=o;for(var p=2;p<r;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3800:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>p,toc:()=>h});var a=n(9122),i=n(2501),r=(n(6393),n(158)),s=["components"],o={title:"Interfacing with Rush"},l=void 0,p={unversionedId:"pages/tutorials/heft_and_rush",id:"pages/tutorials/heft_and_rush",title:"Interfacing with Rush",description:"The Hello World tutorial showed how Heft can be used in a standalone project. Now let's look at how Heft works in the context of a Rush monorepo.",source:"@site/i18n/zh-cn/docusaurus-plugin-content-docs/current/pages/tutorials/heft_and_rush.md",sourceDirName:"pages/tutorials",slug:"/pages/tutorials/heft_and_rush",permalink:"/zh-cn/pages/tutorials/heft_and_rush",draft:!1,editUrl:"https://github.com/microsoft/rushstack-websites/tree/main/websites/heft.rushstack.io/docs/pages/tutorials/heft_and_rush.md",tags:[],version:"current",frontMatter:{title:"Interfacing with Rush"},sidebar:"docsSidebar",previous:{title:"Everyday Heft commands",permalink:"/zh-cn/pages/tutorials/everyday_commands"},next:{title:"@rushstack/heft-config-file",permalink:"/zh-cn/pages/advanced/heft-config-file"}},c={},h=[{value:"How Heft gets invoked",id:"how-heft-gets-invoked",level:2},{value:"Sharing configuration using rig packages",id:"sharing-configuration-using-rig-packages",level:2},{value:"Incremental builds",id:"incremental-builds",level:2},{value:"Using Heft phases to implement Rush phases",id:"using-heft-phases-to-implement-rush-phases",level:2}],u={toc:h},d="wrapper";function m(e){var t=e.components,n=(0,i.Z)(e,s);return(0,r.kt)(d,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"/zh-cn/pages/tutorials/hello_world"},"Hello World")," tutorial showed how Heft can be used in a standalone project. Now let's look at how Heft works in the context of a Rush monorepo."),(0,r.kt)("h2",{id:"how-heft-gets-invoked"},"How Heft gets invoked"),(0,r.kt)("p",null,"If you're new to Rush, the ",(0,r.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/maintainer/setup_new_repo/"},"maintainer tutorials")," explain the basics of setting up a new repo. Heft takes over when Rush invokes the ",(0,r.kt)("inlineCode",{parentName:"p"},'"build"')," script in a Rush project folder. In our sample project from the tutorial, the script looked like this:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"<","project folder",">","/package.json")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n  . . .\n  "scripts": {\n    "build": "heft build --clean",\n    "start": "node lib/start.js"\n  }\n  . . .\n}\n')),(0,r.kt)("h2",{id:"sharing-configuration-using-rig-packages"},"Sharing configuration using rig packages"),(0,r.kt)("p",null,"A major theme in monorepos will be ",(0,r.kt)("em",{parentName:"p"},(0,r.kt)("strong",{parentName:"em"},'minimizing "boilerplate" files')),". In other words, consolidating files and settings that would otherwise get copy+pasted into every single project folder in the monorepo. Boilerplate is a nuisance because it's difficult to keep in sync. When a fix is needed, if you have hundreds of projects, you would need to reapply the same fix hundreds of times. (Even worse, if engineers have been allowed to customize their projects differently, the you might need to apply hundreds of ",(0,r.kt)("em",{parentName:"p"},"different")," fixes, which is a very high maintenance cost.)"),(0,r.kt)("p",null,"At the same time, we want to honor Rush's ",(0,r.kt)("em",{parentName:"p"},(0,r.kt)("strong",{parentName:"em"},"principle of project isolation")),": Each project should build independently and should not become entangled with other projects (for example, by referencing files using relative paths like ",(0,r.kt)("inlineCode",{parentName:"p"},"../../other-project"),"). This discipline facilitates Rush features like subset builds and incremental builds. It also makes it very easy to move Rush project folders around, to migrate projects between monorepos, and even to stop using Rush later if you change your mind. For this reason, we discourage practices such as putting a centralized ",(0,r.kt)("strong",{parentName:"p"},".eslintrc.js")," file in the root of the monorepo and invoking ESLint globally for all projects."),(0,r.kt)("p",null,"Combining these goals, Heft supports a formalism called ",(0,r.kt)("strong",{parentName:"p"},"rig packages"),", where common settings are provided by an NPM package that is added to each project's ",(0,r.kt)("inlineCode",{parentName:"p"},"devDependencies"),". Rig packages offer three different ways to reduce duplication:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Config files can use a setting such as ",(0,r.kt)("inlineCode",{parentName:"li"},'"extends"')," to inherit common settings from a rig. Example: ",(0,r.kt)("strong",{parentName:"li"},"tsconfig.json")),(0,r.kt)("li",{parentName:"ol"},"Riggable config files can be eliminated entirely, using a ",(0,r.kt)("strong",{parentName:"li"},"config/rig.json")," file that directs Heft to find them in the rig package. Example: ",(0,r.kt)("strong",{parentName:"li"},"config/heft.json")),(0,r.kt)("li",{parentName:"ol"},"Riggable dependencies can be provided by the rig package, avoiding the need to add them to your project's ",(0,r.kt)("inlineCode",{parentName:"li"},"devDependencies"),". Example: the ",(0,r.kt)("strong",{parentName:"li"},"typescript")," package")),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"/zh-cn/pages/intro/rig_packages"},"Using rig packages")," article describes this in detail."),(0,r.kt)("h2",{id:"incremental-builds"},"Incremental builds"),(0,r.kt)("p",null,"Another benefit of using Rush with Heft is support for incremental builds. For example, if you run ",(0,r.kt)("inlineCode",{parentName:"p"},"rush build")," twice, the second time it will complete instantly, since all projects have already been built. Interestingly, this incremental build analysis is performed by Rush itself, not Heft."),(0,r.kt)("p",null,"Since JavaScript is an interpreted language, there is a small overhead every time a Node.js process is launched in a project folder. Thus even if Heft performs no work at all, it might take 1 second simply to spin up the toolchain, analyze the input files, and determine that everything is up to date. For a monorepo with 500 projects, that adds up to 500 seconds of analysis. Rush avoids this by performing a global analysis of all projects, comparing the hash of your source files against a hash of the output files. If these hashes are the same, then Rush can determine that a project can be skipped entirely without even launching Heft. Rush's incremental build analysis works for any well-behaved script, not just Heft."),(0,r.kt)("h2",{id:"using-heft-phases-to-implement-rush-phases"},"Using Heft phases to implement Rush phases"),(0,r.kt)("p",null,"Rush's incremental build can be made more granular using ",(0,r.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/maintainer/phased_builds/"},"Rush phases"),".\nHeft phases are specifically designed to align with this model."),(0,r.kt)("p",null,"Here's an excerpt from the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/blob/main/libraries/node-core-library/package.json"},"node-core-library/package.json")," in the Rush Stack monorepo on GitHub:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'  "scripts": {\n    "build": "heft build --clean",\n    "test": "heft test --clean",\n    "_phase:build": "heft run --only build -- --clean",\n    "_phase:test": "heft run --only test -- --clean"\n  },\n')),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},'"test"')," command invokes ",(0,r.kt)("inlineCode",{parentName:"p"},"heft test")," which will perform both ",(0,r.kt)("inlineCode",{parentName:"p"},"build")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"test")," phases, whereas the\n",(0,r.kt)("inlineCode",{parentName:"p"},'"_phase:test"')," command performs only the ",(0,r.kt)("inlineCode",{parentName:"p"},"test")," phase. This works because\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/blob/main/common/config/rush/command-line.json"},"config/rush/command-line.json"),"\nmodels our phase dependencies, so Rush itself will ensure that the ",(0,r.kt)("inlineCode",{parentName:"p"},"build")," phase has run before performing ",(0,r.kt)("inlineCode",{parentName:"p"},"test"),".\nBy exposing these details to Rush, Heft's phases can be optimized using Rush's build cache and even participate\nin distributed builds using the Cobuild feature."))}m.isMDXComponent=!0}}]);