"use strict";(self.webpackChunkheft_rushstack_io=self.webpackChunkheft_rushstack_io||[]).push([[9505],{158:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(6393);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,i=e.originalType,p=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),u=l(n),h=s,d=u["".concat(p,".").concat(h)]||u[h]||m[h]||i;return n?a.createElement(d,r(r({ref:t},c),{},{components:n})):a.createElement(d,r({ref:t},c))}));function d(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var i=n.length,r=new Array(i);r[0]=h;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[u]="string"==typeof e?e:s,r[1]=o;for(var l=2;l<i;l++)r[l]=n[l];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},4491:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>p,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var a=n(9122),s=n(2501),i=(n(6393),n(158)),r=["components"],o={title:"Adding more tasks"},p=void 0,l={unversionedId:"pages/tutorials/adding_tasks",id:"pages/tutorials/adding_tasks",title:"Adding more tasks",description:"This section continues the tutorial project from the Hello World tutorial._",source:"@site/i18n/zh-cn/docusaurus-plugin-content-docs/current/pages/tutorials/adding_tasks.md",sourceDirName:"pages/tutorials",slug:"/pages/tutorials/adding_tasks",permalink:"/zh-cn/pages/tutorials/adding_tasks",draft:!1,editUrl:"https://github.com/microsoft/rushstack-websites/tree/main/websites/heft.rushstack.io/docs/pages/tutorials/adding_tasks.md",tags:[],version:"current",frontMatter:{title:"Adding more tasks"},sidebar:"docsSidebar",previous:{title:"Hello world",permalink:"/zh-cn/pages/tutorials/hello_world"},next:{title:"Everyday Heft commands",permalink:"/zh-cn/pages/tutorials/everyday_commands"}},c={},u=[{value:"Adding unit tests to your project",id:"adding-unit-tests-to-your-project",level:2},{value:"Enabling linting",id:"enabling-linting",level:2}],m={toc:u},h="wrapper";function d(e){var t=e.components,n=(0,s.Z)(e,r);return(0,i.kt)(h,(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"This section continues the tutorial project from the ",(0,i.kt)("a",{parentName:"em",href:"/zh-cn/pages/tutorials/hello_world"},"Hello World")," tutorial.")),(0,i.kt)("p",null,"Heft's ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/intro/architecture"},"architecture")," is designed around plugin packages. Heft ships with\na collection of ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/plugins/package_index"},"official plugin packages")," for the most common build tasks.\nTheir source code can be found in the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/tree/main/heft-plugins"},"rushstack/heft-plugins"),"\nwhich is a great reference, if you want to create your own Heft plugins."),(0,i.kt)("p",null,"Continuing our tutorial, let's enable the two most common plugins: ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/plugins/jest"},"Jest")," for unit tests\nand ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/plugins/lint"},"ESlint")," for style checking."),(0,i.kt)("h2",{id:"adding-unit-tests-to-your-project"},"Adding unit tests to your project"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"First, we need to install the TypeScript typings for Jest. These steps continue the ",(0,i.kt)("strong",{parentName:"p"},"my-app")," project from the ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/tutorials/hello_world"},"Hello World")," tutorial. Recall that this project is not using Rush yet, so we will invoke PNPM directly to add the dependency to our ",(0,i.kt)("strong",{parentName:"p"},"package.json")," file (instead of using ",(0,i.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/commands/rush_add/"},"rush add"),"):"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd my-app\n\n# Because @types packages don't follow SemVer, it's a good idea to use --save-exact\npnpm install --save-dev --save-exact @types/heft-jest\npnpm install --save-dev @rushstack/heft-jest-plugin\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add a ",(0,i.kt)("inlineCode",{parentName:"p"},'"test"')," section to your Heft config file, producing this result:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"config/heft.json")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "$schema": "https://developer.microsoft.com/json-schemas/heft/v0/heft.schema.json",\n\n  "phasesByName": {\n    // Define a phase whose name is "build"\n    "build": {\n      "phaseDescription": "This phase compiles the project source code.",\n\n      // Before invoking the compiler, delete the "dist" and "lib" folders\n      "cleanFiles": [{ "sourcePath": "dist" }, { "sourcePath": "lib" }],\n\n      "tasksByName": {\n        // Define a task whose name is "typescript"\n        "typescript": {\n          "taskPlugin": {\n            // This task will invoke the TypeScript plugin\n            "pluginPackage": "@rushstack/heft-typescript-plugin"\n          }\n        }\n      }\n    },\n\n    // Define a phase whose name is "test"\n    "test": {\n      "phaseDescription": "This phase runs the project\'s unit tests.",\n\n      // This phase requires the "build" phase to be run first\n      "phaseDependencies": ["build"],\n\n      "tasksByName": {\n        // Define a task whose name is "jest"\n        "jest": {\n          "taskPlugin": {\n             // This task will invoke the Jest plugin\n             "pluginPackage": "@rushstack/heft-jest-plugin"\n          }\n        }\n      }\n    }\n  }\n}\n')),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("em",{parentName:"p"},"For complete descriptions of these settings, see ",(0,i.kt)("a",{parentName:"em",href:"/zh-cn/pages/configs/heft_json"},"heft.json")," template.")),(0,i.kt)("p",{parentName:"li"},"If you run ",(0,i.kt)("inlineCode",{parentName:"p"},"heft --help")," you should now see ",(0,i.kt)("inlineCode",{parentName:"p"},"test")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"test-watch")," command-line actions\nbecause our second phase was named ",(0,i.kt)("inlineCode",{parentName:"p"},'"test"'),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Since ",(0,i.kt)("a",{parentName:"p",href:"https://jestjs.io/docs/en/api"},"Jest's API")," consists of global variables, we need to load them globally (whereas most other ",(0,i.kt)("inlineCode",{parentName:"p"},"@types")," packages are loaded via ",(0,i.kt)("inlineCode",{parentName:"p"},"import")," statements in your source code). Update your ",(0,i.kt)("strong",{parentName:"p"},"tsconfig.json")," file to say ",(0,i.kt)("inlineCode",{parentName:"p"},'"types": ["heft-jest", "node"]')," instead of just ",(0,i.kt)("inlineCode",{parentName:"p"},'"types": ["node"]'),". The result should look like this:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"my-app/tsconfig.json")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "$schema": "http://json.schemastore.org/tsconfig",\n\n  "compilerOptions": {\n    "outDir": "lib",\n    "rootDirs": ["src/"],\n\n    "forceConsistentCasingInFileNames": true,\n    "declaration": true,\n    "sourceMap": true,\n    "declarationMap": true,\n    "inlineSources": true,\n    "experimentalDecorators": true,\n    "strict": true,\n    "useUnknownInCatchVariables": false,\n    "esModuleInterop": true,\n    "noEmitOnError": false,\n    "allowUnreachableCode": false,\n\n    "types": ["heft-jest", "node"],\n    "module": "commonjs",\n    "target": "es2017",\n    "lib": ["es2017"]\n  },\n  "include": ["src/**/*.ts"],\n  "exclude": ["node_modules", "lib"]\n}\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Next, we need to add the ",(0,i.kt)("a",{parentName:"p",href:"https://jestjs.io/docs/en/configuration"},"jest.config.json")," config file. The presence of this file causes Heft to invoke the Jest test runner. Heft expects a specific file path ",(0,i.kt)("strong",{parentName:"p"},"config/jest.config.json"),". For most cases, your Jest configuration should simply extend Heft's standard preset as shown below:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"my-app/config/jest.config.json")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},'{\n "extends": "@rushstack/heft-jest-plugin/includes/jest-shared.config.json",\n "collectCoverage": true,\n "coverageThreshold": {\n  "global": {\n    "branches": 50,\n    "functions": 50,\n    "lines": 50,\n    "statements": 50\n    }\n  }\n}\n')),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")," For web projects, you probably want to use\n",(0,i.kt)("inlineCode",{parentName:"p"},"@rushstack/heft-jest-plugin/includes/jest-web.config.json")," instead of ",(0,i.kt)("inlineCode",{parentName:"p"},"jest-shared.config.json"),"\nto support dual outputs as ",(0,i.kt)("inlineCode",{parentName:"p"},"lib-commonjs")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"lib")," folders. See the ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/plugins/jest"},"Jest plugin"),"\ndocumentation for details."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Now we need to add a unit test. Jest supports quite a lot of features, but for this tutorial we'll create a trivial test file. The ",(0,i.kt)("inlineCode",{parentName:"p"},".test.ts")," file extension causes Heft to look for unit tests in this file:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"my-app/src/example.test.ts")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"describe('Example Test', () => {\n  it('correctly runs a test', () => {\n    expect(true).toBeTruthy();\n  });\n});\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To run the test, we need to use the ",(0,i.kt)("inlineCode",{parentName:"p"},"heft test")," action, because ",(0,i.kt)("inlineCode",{parentName:"p"},"heft build")," normally skips testing to speed up development."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# View the command line help\nheft test --help\n\n# Build the project and run tests\nheft test --verbose\n\n# Run Jest in watch mode\nheft test-watch\n")),(0,i.kt)("p",{parentName:"li"},"Wow, ",(0,i.kt)("inlineCode",{parentName:"p"},"heft test --help")," has quite a lot of command-line parameters! Where did they come from?\nThey were added by the Jest plugin's ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin/heft-plugin.json"},"heft-plugin.json")," manifest file because we loaded that plugin in our phase."),(0,i.kt)("p",{parentName:"li"},"(What happens if two different plugins define the same command-line parameter? Heft includes a sophisticated\ndisambiguation mechanism, for example allowing you to use ",(0,i.kt)("inlineCode",{parentName:"p"},"--jest:update-snapshots")," instead of ",(0,i.kt)("inlineCode",{parentName:"p"},"--update-snapshots"),"\nif some other plugin also defines a ",(0,i.kt)("inlineCode",{parentName:"p"},"--update-snapshots")," parameter.)")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"We should update our ",(0,i.kt)("strong",{parentName:"p"},"package.json")," script so that ",(0,i.kt)("inlineCode",{parentName:"p"},"pnpm run test")," will run the Jest tests:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"my-app/package.json")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},'{\n  . . .\n  "scripts": {\n    "build": "heft build --clean",\n    "test": "heft test --clean",\n    "start": "node lib/start.js"\n  },\n  . . .\n}\n')))),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")," Do not invoke the ",(0,i.kt)("inlineCode",{parentName:"p"},"jest")," command line directly. Doing so would run the tests that it finds\nin ",(0,i.kt)("inlineCode",{parentName:"p"},"lib/**/*.js"),", but it will not invoke Heft's other tasks needed to update those output files.")),(0,i.kt)("p",null,"That's it for setting up Jest! Further information, including instructions for debugging tests, can be found in the ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/plugins/jest"},"Jest plugin")," reference and the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack-samples/tree/main/heft/heft-node-jest-tutorial"},"heft-node-jest-tutorial")," sample project."),(0,i.kt)("h2",{id:"enabling-linting"},"Enabling linting"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To ensure best practices and catch common mistakes, let's also enable the ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@rushstack/eslint-config"},"@rushstack/eslint-config")," standard ruleset. First we need to add a few more NPM dependencies to our ",(0,i.kt)("strong",{parentName:"p"},"package.json")," file."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd my-app\n\n# Add the ESLint engine\npnpm install --save-dev eslint\n\n# Add Heft's plugin for ESLint\npnpm install --save-dev @rushstack/heft-lint-plugin\n\n# Add Rush Stack's all-in-one lint ruleset\npnpm install --save-dev @rushstack/eslint-config\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Update your Heft config file to add a task that loads ",(0,i.kt)("inlineCode",{parentName:"p"},"@rushstack/heft-lint-plugin")," during the ",(0,i.kt)("inlineCode",{parentName:"p"},"heft build")," phase:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"config/heft.json")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "$schema": "https://developer.microsoft.com/json-schemas/heft/v0/heft.schema.json",\n\n  "phasesByName": {\n    // Define a phase whose name is "build"\n    "build": {\n      "phaseDescription": "Compiles the project source code",\n\n      // Before invoking the compiler, delete the "dist" and "lib" folders\n      "cleanFiles": [{ "sourcePath": "dist" }, { "sourcePath": "lib" }],\n\n      "tasksByName": {\n        // Define a task whose name is "typescript"\n        "typescript": {\n          "taskPlugin": {\n            // This task will invoke the TypeScript plugin\n            "pluginPackage": "@rushstack/heft-typescript-plugin"\n          }\n        },\n\n        // Define a task whose name is "lint"\n        "lint": {\n         // This task should run after "typescript" has completed\n         // because Heft optimizes ESLint by reusing the TypeScript\n         // compiler\'s AST analysis\n         "taskDependencies": ["typescript"],\n         "taskPlugin": {\n           // This task will invoke the ESLint plugin\n           "pluginPackage": "@rushstack/heft-lint-plugin"\n         }\n       }\n      }\n    },\n    // Define a phase whose name is "test"\n    "test": {\n      // This phase requires the "build" phase to be run first\n      "phaseDependencies": ["build"],\n      "tasksByName": {\n        // Define a task whose name is "jest"\n        "jest": {\n          "taskPlugin": {\n             // This task will invoke the Jest plugin\n             "pluginPackage": "@rushstack/heft-jest-plugin"\n          }\n        }\n      }\n    }\n  }\n}\n')),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("em",{parentName:"p"},"For complete descriptions of these settings, see ",(0,i.kt)("a",{parentName:"em",href:"/zh-cn/pages/configs/heft_json"},"heft.json")," template."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Next, create the ",(0,i.kt)("a",{parentName:"p",href:"https://eslint.org/docs/user-guide/configuring"},".eslintrc.js")," config file. For this tutorial we'll just use the official Rush Stack ruleset:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"my-app/.eslintrc.js")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// This is a workaround for https://github.com/eslint/eslint/issues/3458\nrequire('@rushstack/eslint-config/patch/modern-module-resolution');\n\nmodule.exports = {\n  extends: ['@rushstack/eslint-config/profile/node'],\n  parserOptions: { tsconfigRootDir: __dirname }\n};\n")),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("em",{parentName:"p"},"Note: If your project uses the ",(0,i.kt)("a",{parentName:"em",href:"https://reactjs.org/"},"React")," framework, you should also extend from the ",(0,i.kt)("inlineCode",{parentName:"em"},'"@rushstack/eslint-config/mixins/react"')," mixin. See ",(0,i.kt)("a",{parentName:"em",href:"https://www.npmjs.com/package/@rushstack/eslint-config"},"the documentation")," for details about ",(0,i.kt)("inlineCode",{parentName:"em"},"@rushstack/eslint-config"),' "profiles" and "mixins".'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"To test it out, try updating your ",(0,i.kt)("strong",{parentName:"p"},"start.ts")," source file to introduce a lint issue:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"my-app/src/start.ts")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"console.log('Hello, world!');\n\nexport function f() {\n  // <--- oops\n}\n")),(0,i.kt)("p",{parentName:"li"},"When you run ",(0,i.kt)("inlineCode",{parentName:"p"},"pnpm run build"),", you should see a log message like this:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"-------------------- Finished (3.555s) --------------------\nEncountered 1 warning\n[build:lint] src/start.ts:3:8 - (@typescript-eslint/explicit-function-return-type) Missing return type on function.\n")),(0,i.kt)("p",{parentName:"li"},"To fix the problem, fix the code to add the missing return type, and it should now build successfully:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"my-app/src/start.ts")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"console.log('Hello, world!');\n\nexport function f(): void {\n  // <--- okay\n}\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"@rushstack/eslint-config")," ruleset is designed to work together with the Prettier code formatter.\nTo set that up, see the ",(0,i.kt)("a",{parentName:"p",href:"https://rushjs.io/pages/maintainer/enabling_prettier/"},"Enabling Prettier")," article\non the Rush website."))),(0,i.kt)("p",null,"That's it for ESLint! More detail can be found in the ",(0,i.kt)("a",{parentName:"p",href:"/zh-cn/pages/plugins/lint"},"Lint plugin")," reference."))}d.isMDXComponent=!0}}]);