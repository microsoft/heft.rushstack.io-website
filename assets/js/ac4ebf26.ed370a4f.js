"use strict";(self.webpackChunkheft_rushstack_io=self.webpackChunkheft_rushstack_io||[]).push([[8830],{158:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(6393);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=u(n),m=s,h=c["".concat(l,".").concat(m)]||c[m]||d[m]||r;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function h(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,o=new Array(r);o[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[c]="string"==typeof e?e:s,o[1]=i;for(var u=2;u<r;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7171:(e,t,n)=>{n.d(t,{Z:()=>o});var a=n(6393),s=n(5881);const r={tabItem:"tabItem_bzwk"};function o(e){var t=e.children,n=e.hidden,o=e.className;return a.createElement("div",{role:"tabpanel",className:(0,s.Z)(r.tabItem,o),hidden:n},t)}},3473:(e,t,n)=>{n.d(t,{Z:()=>j});var a=n(9122),s=n(6393),r=n(5881),o=n(1149),i=n(8791),l=n(5602),u=n(7947),p=n(2026);function c(e){return function(e){return s.Children.map(e,(function(e){if((0,s.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')}))}(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}function d(e){var t=e.values,n=e.children;return(0,s.useMemo)((function(){var e=null!=t?t:c(n);return function(e){var t=(0,u.l)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,n])}function m(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function h(e){var t=e.queryString,n=void 0!==t&&t,a=e.groupId,r=(0,i.k6)(),o=function(e){var t=e.queryString,n=void 0!==t&&t,a=e.groupId;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=a?a:null}({queryString:n,groupId:a});return[(0,l._X)(o),(0,s.useCallback)((function(e){if(o){var t=new URLSearchParams(r.location.search);t.set(o,e),r.replace(Object.assign({},r.location,{search:t.toString()}))}}),[o,r])]}function f(e){var t,n,a,r,o=e.defaultValue,i=e.queryString,l=void 0!==i&&i,u=e.groupId,c=d(e),f=(0,s.useState)((function(){return function(e){var t,n=e.defaultValue,a=e.tabValues;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!m({value:n,tabValues:a}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+n+'" but none of its children has the corresponding value. Available values are: '+a.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return n}var s=null!=(t=a.find((function(e){return e.default})))?t:a[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:o,tabValues:c})})),g=f[0],k=f[1],b=h({queryString:l,groupId:u}),v=b[0],y=b[1],j=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:u}.groupId),n=(0,p.Nk)(t),a=n[0],r=n[1],[a,(0,s.useCallback)((function(e){t&&r.set(e)}),[t,r])]),N=j[0],w=j[1],T=function(){var e=null!=v?v:N;return m({value:e,tabValues:c})?e:null}();return(0,s.useLayoutEffect)((function(){T&&k(T)}),[T]),{selectedValue:g,selectValue:(0,s.useCallback)((function(e){if(!m({value:e,tabValues:c}))throw new Error("Can't select invalid tab value="+e);k(e),y(e),w(e)}),[y,w,c]),tabValues:c}}var g=n(7499);const k={tabList:"tabList_UTb5",tabItem:"tabItem_JDHA"};function b(e){var t=e.className,n=e.block,i=e.selectedValue,l=e.selectValue,u=e.tabValues,p=[],c=(0,o.o5)().blockElementScrollPositionUntilNextRender,d=function(e){var t=e.currentTarget,n=p.indexOf(t),a=u[n].value;a!==i&&(c(t),l(a))},m=function(e){var t,n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":var a,s=p.indexOf(e.currentTarget)+1;n=null!=(a=p[s])?a:p[0];break;case"ArrowLeft":var r,o=p.indexOf(e.currentTarget)-1;n=null!=(r=p[o])?r:p[p.length-1]}null==(t=n)||t.focus()};return s.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t)},u.map((function(e){var t=e.value,n=e.label,o=e.attributes;return s.createElement("li",(0,a.Z)({role:"tab",tabIndex:i===t?0:-1,"aria-selected":i===t,key:t,ref:function(e){return p.push(e)},onKeyDown:m,onClick:d},o,{className:(0,r.Z)("tabs__item",k.tabItem,null==o?void 0:o.className,{"tabs__item--active":i===t})}),null!=n?n:t)})))}function v(e){var t=e.lazy,n=e.children,a=e.selectedValue;if(n=Array.isArray(n)?n:[n],t){var r=n.find((function(e){return e.props.value===a}));return r?(0,s.cloneElement)(r,{className:"margin-top--md"}):null}return s.createElement("div",{className:"margin-top--md"},n.map((function(e,t){return(0,s.cloneElement)(e,{key:t,hidden:e.props.value!==a})})))}function y(e){var t=f(e);return s.createElement("div",{className:(0,r.Z)("tabs-container",k.tabList)},s.createElement(b,(0,a.Z)({},e,t)),s.createElement(v,(0,a.Z)({},e,t)))}function j(e){var t=(0,g.Z)();return s.createElement(y,(0,a.Z)({key:String(t)},e))}},6621:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>p,default:()=>g,frontMatter:()=>u,metadata:()=>c,toc:()=>m});var a=n(9122),s=n(2501),r=(n(6393),n(158)),o=n(3473),i=n(7171),l=["components"],u={title:"Jest plugin"},p=void 0,c={unversionedId:"pages/plugins/jest",id:"pages/plugins/jest",title:"Jest plugin",description:"|     |     |",source:"@site/docs/pages/plugins/jest.md",sourceDirName:"pages/plugins",slug:"/pages/plugins/jest",permalink:"/pages/plugins/jest",draft:!1,editUrl:"https://github.com/microsoft/rushstack-websites/tree/main/websites/heft.rushstack.io/docs/pages/plugins/jest.md",tags:[],version:"current",frontMatter:{title:"Jest plugin"},sidebar:"docsSidebar",previous:{title:"Dev certificate plugins",permalink:"/pages/plugins/dev-cert"},next:{title:"ESlint / TSLint plugins",permalink:"/pages/plugins/lint"}},d={},m=[{value:"When to use it",id:"when-to-use-it",level:2},{value:"package.json dependencies",id:"packagejson-dependencies",level:2},{value:"Configuration",id:"configuration",level:2},{value:"The &quot;extends&quot; field",id:"the-extends-field",level:2},{value:"Differences from ts-jest",id:"differences-from-ts-jest",level:2},{value:"Debugging Jest tests",id:"debugging-jest-tests",level:2},{value:"CLI parameters",id:"cli-parameters",level:2},{value:"heft.json plugin options",id:"heftjson-plugin-options",level:2},{value:"See also",id:"see-also",level:2}],h={toc:m},f="wrapper";function g(e){var t=e.components,n=(0,s.Z)(e,l);return(0,r.kt)(f,(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("table",null,(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Plugin package:")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin"},"@rushstack/heft-jest-plugin"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Plugin name:")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin/heft-plugin.json"},"jest-plugin")," implemented by ",(0,r.kt)("a",{parentName:"td",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin/src/JestPlugin.ts"},"JestPlugin.ts"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"Plugin config file:")),(0,r.kt)("td",{parentName:"tr",align:null},"Jest's ",(0,r.kt)("a",{parentName:"td",href:"https://jestjs.io/docs/configuration"},"jest.config.json")," loaded by ",(0,r.kt)("inlineCode",{parentName:"td"},"@rushstack/heft-config-file")," for rigging")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"td"},"heft.json options:")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("a",{parentName:"td",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin/src/JestPlugin.ts"},"IJestPluginOptions"))))),(0,r.kt)("p",null,"This plugin invokes the ",(0,r.kt)("a",{parentName:"p",href:"https://jestjs.io/en/"},"Jest")," test framework for unit testing."),(0,r.kt)("h2",{id:"when-to-use-it"},"When to use it"),(0,r.kt)("p",null,"We recommend Jest for several reasons:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"All-in-one"),": Unlike frameworks such as ",(0,r.kt)("inlineCode",{parentName:"p"},"mocha")," that require many components to be hooked together, Jest provides a single integrated solution for your: test runner, assertion library, mock/spy API, instrumentation, code coverage, and reporting. Jest also has first class support for React.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Interactive"),': Jest supports a "watch mode" for automatically re-running tests whenever a file is saved, plus a ',(0,r.kt)("a",{parentName:"p",href:"https://jestjs.io/docs/en/snapshot-testing"},"snapshot testing")," that can automatically update assertions when a contract changes.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Isolated runtime"),": Jest runs web tests in a Node.js environment rather than launching a web browser, and leverages the ",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/api/vm.html"},"Node.js VM")," feature to prevent tests from leaking state."))),(0,r.kt)("p",null,"That said, if for some reason you need to run tests in some other runtime such as an Android client or real web browser, Jest may not be the best bet."),(0,r.kt)("h2",{id:"packagejson-dependencies"},"package.json dependencies"),(0,r.kt)("p",null,"If you are using a standard rig such as ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/tree/main/rigs/heft-node-rig"},"@rushstack/heft-node-rig"),"\nor ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/tree/main/rigs/heft-web-rig"},"@rushstack/heft-web-rig"),", then Jest\nwill already be loaded and configured."),(0,r.kt)("p",null,"Otherwise, you'll need to add the plugin package to your project:"),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"rush-install",label:"Rush",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# If you are using Rush, run this shell command in your project folder:\nrush add --package @rushstack/heft-jest-plugin --dev\n"))),(0,r.kt)(i.Z,{value:"npm-install",label:"NPM",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# If you are using vanilla NPM, run this shell command in your project folder:\nnpm install @rushstack/heft-jest-plugin --save-dev\n")))),(0,r.kt)("p",null,"The plugin has direct dependencies on the Jest packages that it needs, so you don't need to add Jest to your\nproject's ",(0,r.kt)("strong",{parentName:"p"},"package.json")," file."),(0,r.kt)("p",null,"Your project should get its typings from ",(0,r.kt)("inlineCode",{parentName:"p"},"@types/heft-jest")," instead of ",(0,r.kt)("inlineCode",{parentName:"p"},"@types/jest"),":"),(0,r.kt)(o.Z,{mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"rush-install",label:"Rush",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# If you are using Rush, run this shell command in your project folder:\nrush add --package @types/heft-jest --dev --exact\n\n# Because @types packages don't follow SemVer, it's a good idea to use --exact\n"))),(0,r.kt)(i.Z,{value:"npm-install",label:"NPM",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# If you are using vanilla NPM, run this shell command in your project folder:\nnpm install @types/heft-jest --save-dev --save-exact\n\n# Because @types packages don't follow SemVer, it's a good idea to use --save-exact\n")))),(0,r.kt)("p",null,"...and then reference the ",(0,r.kt)("inlineCode",{parentName:"p"},"@types/heft-jest")," in your ",(0,r.kt)("strong",{parentName:"p"},"tsconfig.json")," file, like this example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "extends": "./node_modules/@rushstack/heft-node-rig/profiles/default/tsconfig-base.json",\n  "compilerOptions": {\n    "types": [\n      "heft-jest", // <---- ADD THIS\n      "node"\n    ]\n  }\n}\n')),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"If Jest is not already being provided by a rig, your ",(0,r.kt)("a",{parentName:"p",href:"/pages/configs/heft_json"},"heft.json config file")," could invoke it\nlike in this example:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"<","project folder",">","/config/heft.json")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "$schema": "https://developer.microsoft.com/json-schemas/heft/v0/heft.schema.json",\n\n  "phasesByName": {\n    "build": {\n      . . .\n    },\n    "test": {\n      "phaseDependencies": ["build"],\n      "tasksByName": {\n        "jest": {\n          "taskPlugin": {\n            "pluginPackage": "@rushstack/heft-jest-plugin"\n          }\n        }\n      }\n    }\n  }\n}\n')),(0,r.kt)("p",null,"Heft looks for ",(0,r.kt)("a",{parentName:"p",href:"https://jestjs.io/docs/en/configuration"},"Jest's config file")," in the standard path\n",(0,r.kt)("strong",{parentName:"p"},"config/jest.config.json"),". Although Jest itself supports other config file names and even embedding settings\nin your ",(0,r.kt)("strong",{parentName:"p"},"package.json")," file, Heft requires the name ",(0,r.kt)("inlineCode",{parentName:"p"},"config/jest.config.json"),". In a large scale monorepo,\nenforcing one standard filename makes it easier to search for these files, perform bulk edits, and copy configuration\nrecipes between projects."),(0,r.kt)("p",null,"For a simple setup, your Jest configuration should extend Heft's\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin/includes/jest-shared.config.json"},"jest-shared.config.json")," like this:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"<","project folder",">","/config/jest.config.json")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "extends": "@rushstack/heft-jest-plugin/includes/jest-shared.config.json"\n}\n')),(0,r.kt)("p",null,"Alternatively, if you are using a rig package such as ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/heft-web-rig"),", specify the rig like in this example:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"<","project folder",">","/config/jest.config.json")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "extends": "@rushstack/heft-web-rig/profiles/library/config/jest.config.json"\n}\n')),(0,r.kt)("p",null,"(If you maintain your own rig, it should extend from ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/heft-jest-plugin")," to ensure that Jest uses\nHeft's transforms and resolver.)"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},(0,r.kt)("strong",{parentName:"em"},"Note:")," If you find yourself frequently adding lots of custom settings to ",(0,r.kt)("strong",{parentName:"em"},"jest.config.json"),", please create\na GitHub issue and tell us about it. Our aim is to provide a configuration that minimizes the need for\nproject-specific customizations.")),(0,r.kt)("h2",{id:"the-extends-field"},'The "extends" field'),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},'"extends"')," field in ",(0,r.kt)("strong",{parentName:"p"},"jest.config.json")," is a Heft-specific enhancement that will not work if the Jest\ncommand line is invoked without Heft. This setting replaces Jest's ",(0,r.kt)("inlineCode",{parentName:"p"},'"preset"')," field which has limited module\nresolution capabilities and does not support rigs. Heft parses ",(0,r.kt)("strong",{parentName:"p"},"jest.config.json")," using\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/heft-config-file")," engine, with full support for\n",(0,r.kt)("a",{parentName:"p",href:"/pages/advanced/heft-config-file#property-inheritance-directives"},"property inheritance directives"),"."),(0,r.kt)("p",null,"If for some reason your ",(0,r.kt)("inlineCode",{parentName:"p"},"jest.config.json")," needs to be directly readable by Jest, the\n",(0,r.kt)("inlineCode",{parentName:"p"},"disableConfigurationModuleResolution")," plugin setting can be used to restore the standard behavior,\nwith the downside that your Jest configuration will not be riggable."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"<","project folder",">","/config/heft.json")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "$schema": "https://developer.microsoft.com/json-schemas/heft/v0/heft.schema.json",\n\n  "phasesByName": {\n    "build": {\n      . . .\n    },\n    "test": {\n      "phaseDependencies": ["build"],\n      "tasksByName": {\n        "jest": {\n          "taskPlugin": {\n            "pluginPackage": "@rushstack/heft-jest-plugin",\n            "options": {\n              // (Not recommended) Disable Heft\'s support for rigs and the "extends" field\n              "disableConfigurationModuleResolution": true\n            }\n          }\n        }\n      }\n    }\n  }\n}\n')),(0,r.kt)("h2",{id:"differences-from-ts-jest"},"Differences from ts-jest"),(0,r.kt)("p",null,"Conventionally, Jest supports TypeScript compilation via plugins called ",(0,r.kt)("a",{parentName:"p",href:"https://jestjs.io/docs/en/tutorial-react#custom-transformers"},"transforms"),", which are modeled as a function that receives a single ",(0,r.kt)("inlineCode",{parentName:"p"},".ts")," file as input, and returns a ",(0,r.kt)("inlineCode",{parentName:"p"},".js")," file and ",(0,r.kt)("inlineCode",{parentName:"p"},".map")," file as its output. The official ",(0,r.kt)("inlineCode",{parentName:"p"},"babel-jest")," transform actually does compile one file at a time, but that approach cannot support language features such as ",(0,r.kt)("inlineCode",{parentName:"p"},"const enum")," that require analyzing imported types. The popular ",(0,r.kt)("inlineCode",{parentName:"p"},"ts-jest")," transform solves that problem by performing a full compiler analysis and reusing it each time the transform is invoked, but this won't support other build steps such as preprocessors. Both ",(0,r.kt)("inlineCode",{parentName:"p"},"babel-jest")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"ts-jest")," also impose a significant performance cost, by invoking the compiler a second time when running tests."),(0,r.kt)("p",null,"Heft takes a different approach of performing a conventional build and then invoking Jest on the output. If your build targets a browser runtime, you'll need to use the ",(0,r.kt)("a",{parentName:"p",href:"/pages/configs/typescript_json"},"additionalModuleKindsToEmit")," setting to emit CommonJS outputs in a secondary folder. (Emitting extra files is still significantly faster than invoking the compiler twice.) Besides avoiding redundant compiler invocations, Heft's strategy ensures that your unit tests are compiled with your full build process including any preprocessor tasks such as ",(0,r.kt)("a",{parentName:"p",href:"/pages/plugins/sass"},"Sass typings generation"),"."),(0,r.kt)("p",null,"Some helpful examples of mocking and other Jest techniques can be found in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack-samples/tree/main/heft/heft-node-jest-tutorial"},"heft-node-jest-tutorial")," project folder."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Important differences when using Jest with Heft:")),(0,r.kt)("ul",{parentName:"blockquote"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Invoke Jest using the ",(0,r.kt)("inlineCode",{parentName:"p"},"heft")," command line. Invoking the ",(0,r.kt)("inlineCode",{parentName:"p"},"jest")," command line directly will not invoke TypeScript and is incompatible with the ",(0,r.kt)("inlineCode",{parentName:"p"},'"extends"')," field from ",(0,r.kt)("strong",{parentName:"p"},"jest.config.json"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Do not add ",(0,r.kt)("inlineCode",{parentName:"p"},"ts-jest")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"babel-jest")," as a dependency for your project.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Instead of ",(0,r.kt)("inlineCode",{parentName:"p"},'import { mocked } from "ts-jest/utils";'),", use the global ",(0,r.kt)("inlineCode",{parentName:"p"},"mocked()")," function that is provided by ",(0,r.kt)("inlineCode",{parentName:"p"},"@types/heft-jest"),". Besides this difference, the ",(0,r.kt)("a",{parentName:"p",href:"https://kulshekhar.github.io/ts-jest/docs/guides/test-helpers/"},"API documentation")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"ts-jest")," is still applicable to Heft's implementation.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ts-jest"),' transform will magically "hoist" calls to ',(0,r.kt)("inlineCode",{parentName:"p"},"jest.mock();"),". Heft does not consider this a best practice. Instead, use the ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@rushstack/eslint-plugin#rushstackhoist-jest-mock"},"@rushstack/hoist-jest-mock")," lint rule to remind developers to manually hoist their calls. It is enabled by default with ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@rushstack/eslint-config"},"@rushstack/eslint-config"),".")))),(0,r.kt)("h2",{id:"debugging-jest-tests"},"Debugging Jest tests"),(0,r.kt)("p",null,"To debug your Jest tests, it's recommended create a VS Code ",(0,r.kt)("a",{parentName:"p",href:"https://code.visualstudio.com/docs/editor/debugging#_launch-configurations"},"launch.json file")," like this:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"<","project folder",">","/.vscode/launch.json")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'{\n  "version": "0.2.0",\n  "configurations": [\n    {\n      "type": "node",\n      "request": "launch",\n      "name": "Debug Jest tests",\n      "program": "${workspaceFolder}/node_modules/@rushstack/heft/lib/start.js",\n      "cwd": "${workspaceFolder}",\n      "args": ["--debug", "test", "--clean"],\n      "console": "integratedTerminal",\n      "sourceMaps": true\n    },\n  ]\n}\n')),(0,r.kt)("p",null,"This launches the full Heft toolchain in your debugger. The ",(0,r.kt)("inlineCode",{parentName:"p"},"--debug")," switch prevents Jest from being spawned as a separate process. The ",(0,r.kt)("inlineCode",{parentName:"p"},"--clean"),' flag is optional, but fixes an issue where in rare situations Jest\'s "haste-map" may become corrupted by an aborted run.'),(0,r.kt)("p",null,"To restrict the debugger to run one specific test, you can add the ",(0,r.kt)("inlineCode",{parentName:"p"},"--test-name-pattern")," parameter. (See ",(0,r.kt)("a",{parentName:"p",href:"/pages/intro/cli"},"here")," for command-line documentation.) Another option is to use Jest's ",(0,r.kt)("a",{parentName:"p",href:"https://jestjs.io/docs/en/api#testonlyname-fn-timeout"},"test.only()")," API."),(0,r.kt)("h2",{id:"cli-parameters"},"CLI parameters"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin/heft-plugin.json"},"heft-jest-plugin/heft-plugin.json")," defines these parameters:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'  --config RELATIVE_PATH\n                        Use this parameter to control which Jest\n                        configuration file will be used to run Jest tests. If\n                        not specified, it will default to "config/jest.config.\n                        json". This corresponds to the "--config" parameter\n                        in Jest\'s documentation.\n  --debug-heft-reporter\n                        Normally Heft installs a custom Jest reporter so that\n                        test results are presented consistently with other\n                        task logging. If you suspect a problem with the\n                        HeftJestReporter, specify "--debug-heft-reporter" to\n                        temporarily disable it so that you can compare with\n                        how Jest\'s default reporter would have presented it.\n                        Include this output in your bug report. Do not use\n                        "--debug-heft-reporter" in production.\n  --detect-open-handles\n                        Attempt to collect and print open handles preventing\n                        Jest from exiting cleanly. This option has a\n                        significant performance penalty and should only be\n                        used for debugging. This corresponds to the\n                        "--detectOpenHandles" parameter in Jest\'s\n                        documentation.\n  --disable-code-coverage\n                        Disable any configured code coverage. If code\n                        coverage is not configured, this parameter has no\n                        effect.\n  --find-related-tests SOURCE_FILE\n                        Find and run the tests that cover a source file that\n                        was passed in as an argument. This corresponds to the\n                        "--findRelatedTests" parameter in Jest\'s\n                        documentation. This parameter is not compatible with\n                        watch mode.\n  --max-workers COUNT_OR_PERCENTAGE\n                        Use this parameter to control maximum number of\n                        worker processes tests are allowed to use. This\n                        parameter is similar to the parameter noted in the\n                        Jest documentation, and can either be an integer\n                        representing the number of workers to spawn when\n                        running tests, or can be a string representing a\n                        percentage of the available CPUs on the machine to\n                        utilize. Example values: "3", "25%"\n  --silent\n                        Prevent tests from printing messages through the\n                        console. This corresponds to the "--silent" parameter\n                        in Jest\'s documentation.\n  -t REGEXP, --test-name-pattern REGEXP\n                        Run only tests with a name that matches a regular\n                        expression. The REGEXP is matched against the full\n                        name, which is a combination of the test name and all\n                        its surrounding describe blocks. This corresponds to\n                        the "--testNamePattern" parameter in Jest\'s\n                        documentation.\n  --test-path-ignore-patterns REGEXP\n                        Avoid running tests with a source file path that\n                        matches one ore more regular expressions. On Windows\n                        you will need to use "/" instead of "\\". This\n                        corresponds to the "--testPathIgnorePatterns"\n                        parameter in Jest\'s documentation.\n  --test-path-pattern REGEXP\n                        Run only tests with a source file path that matches a\n                        regular expression. On Windows you will need to use\n                        "/" instead of "\\". This corresponds to the\n                        "--testPathPattern" parameter in Jest\'s documentation.\n  --test-timeout-ms TIMEOUT\n                        Change the default timeout for tests; if a test\n                        doesn\'t complete within this many milliseconds, it\n                        will fail. Individual tests can override the default.\n                        If unspecified, the default is normally 5000 ms. This\n                        corresponds to the "--testTimeout" parameter in\n                        Jest\'s documentation.\n  -u, --update-snapshots\n                        Update Jest snapshots while running the tests. This\n                        corresponds to the "--updateSnapshots" parameter in\n                        Jest.\n')),(0,r.kt)("h2",{id:"heftjson-plugin-options"},"heft.json plugin options"),(0,r.kt)("p",null,"When loading ",(0,r.kt)("inlineCode",{parentName:"p"},"@rushstack/heft-jest-plugin")," in your ",(0,r.kt)("strong",{parentName:"p"},"heft.json"),", the following settings can be provided inline using the ",(0,r.kt)("inlineCode",{parentName:"p"},'"options"')," field:"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/microsoft/rushstack/blob/main/heft-plugins/heft-jest-plugin/src/JestPlugin.ts"},"heft-plugins/heft-jest-plugin/src/JestPlugin.ts")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export interface IJestPluginOptions {\n  configurationPath?: string;\n  debugHeftReporter?: boolean;\n  detectOpenHandles?: boolean;\n  disableCodeCoverage?: boolean;\n  disableConfigurationModuleResolution?: boolean;\n  findRelatedTests?: string[];\n  maxWorkers?: string;\n  passWithNoTests?: boolean;\n  silent?: boolean;\n  testNamePattern?: string;\n  testPathIgnorePatterns?: string;\n  testPathPattern?: string;\n  testTimeout?: number;\n  updateSnapshots?: boolean;\n}\n")),(0,r.kt)("p",null,"Their function is identical to the corresponding command-line parameters."),(0,r.kt)("h2",{id:"see-also"},"See also"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/microsoft/rushstack-samples/tree/main/heft/heft-node-jest-tutorial"},"heft-node-jest-tutorial")," sample project"),(0,r.kt)("li",{parentName:"ul"},"Jest's ",(0,r.kt)("a",{parentName:"li",href:"https://jestjs.io/docs/en/api"},"API reference")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://jestjs.io/docs/en/configuration"},"jest.config.json")," documentation")))}g.isMDXComponent=!0}}]);